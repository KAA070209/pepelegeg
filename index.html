<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>pepelegeg</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      /* === GLOBAL === */
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #f7f7f9;
        color: #333;
        padding-top: 100px;
        transition: background 0.5s, color 0.5s;
      }
      h1, h2, h5 {
        font-weight: 600;
      }

      #dashboard {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 20px;
      }

      #dashboard h1 {
        text-align: left;
        margin-right: auto;
      }

      #dashboard .row {
        justify-content: center; /* supaya col di tengah */
        width: 100%;
      }

      #dashboard .card {
        min-height: 140px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* === NAVBAR === */
      .navbar {
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        background-color:black;
        color: white;
      }
      .navbar-brand {
        font-size: 1.3rem;
        font-weight: bold;
      }
      .nav-link {
        transition: 0.2s;
      }
      .nav-link:hover {
        color: #0d6efd;
      }

      /* === CARD DASHBOARD === */
      .card {
        border: none;
        border-radius: 15px;
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-5px);
        transform: scale(1.03);
        transition: 0.3s ease-in-out;
      }
      .card h5 {
        margin-bottom: 0.5rem;
        color: #555;
      }
      .card p {
        font-size: 0.9rem;
        color: #666;
      }

      /* === CALENDAR === */
      .calendar {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
      }
      .calendar .weekdays div, .calendar .day {
        padding: 8px;
        text-align: center;
        font-size: 0.85rem;
      }
      .calendar .weekdays {
        background: #eee;
        font-weight: 600;
      }
      .calendar .day {
        cursor: pointer;
        min-height: 100px;
        position: relative;
        transition: background 0.2s;
      }
      .calendar .day:hover {
        background: #f0f9ff !important;
      }
      .calendar .day.today {
        border: 2px solid #0d6efd;
        border-radius: 8px;
      }
      .task-preview {
        margin-top: 4px;
        text-align: left;
        font-size: 0.75rem;
      }

      /* === MODAL === */
      .modal-content {
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      }
      #taskList div {
        padding: 4px;
        border-bottom: 1px solid #eee;
      }
      #taskList div:last-child {
        border-bottom: none;
      }

      #taskList div {
        padding: 4px;
        border-bottom: 1px solid #eee;
      }


      /* === BUTTONS === */
      .btn {
        border-radius: 8px;
        font-weight: 500;
      }
      .btn-success {
        background: linear-gradient(90deg, #00b09b, #96c93d);
        border: none;
        transition: all 0.3s ease;
      }

      .btn-success:hover {
        background: #6c757d;   /* abu-abu Bootstrap */
        color: #fff;
        transform: scale(1.05);
        transition: 0.3s ease-in-out;
      }
      .btn-outline-danger:hover {
        background: #dc3545;
        color: #fff;
      }

      /* === LISTS === */
      .list-group-item {
        border: none;
        border-radius: 8px;
        margin-bottom: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      }

      /* === CHART CONTAINER === */
      .chart-container {
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        background: #ffffff;
        color: #000000;
      }

    .hidden { display: none !important; }

        /* Default (Light Mode) */
    .calendar {
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Header / weekdays */
    .calendar .weekdays div {
      background: #000000;
      color: #ffffff;
      font-weight: bold;
      text-align: center;
      padding: 10px 0;
      border: 1px solid #ddd;
    }

    /* Isi hari */
    .calendar .days .day,
    .calendar .days .empty {
      background: #ffffff;
      color: #000000;
      min-height: 100px;
      padding: 5px;
      border: 1px solid #ddd;
    }

    /* Hari ini (highlight) */
    .calendar .days .today {
      border: 2px solid #007bff;
      font-weight: bold;
    }

    .btnA {
      border-radius: 8px;
      font-weight: 500;
      background: #0d6efd;
      color: #fff;
      padding: 8px 12px;
      text-decoration: none;
      transition: background 0.2s;
    }

    .btnA:hover {
      background: #0b5ed7;  
    }

    input[type=checkbox] {
      accent-color: #0d6efd;
      cursor: pointer;
    }

        #modeToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      padding: 10px 15px;
      border-radius: 50%;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #modeToggle:hover {
      transform: scale(1.1) rotate(10deg);
      background: #0b5ed7;
    }

    .section {
      animation: fadeIn 0.8s ease-in-out;
    }

    .card {
      animation: floatUp 0.8s ease-in-out;
    }

    .btn, .btnA {
      transition: all 0.3s ease-in-out;
    }
    .btn:hover, .btnA:hover {
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
      transform: translateY(-2px) scale(1.05);
    }

    .navbar {
      animation: slideDown 0.8s ease-in-out;
    }

    input, select, textarea {
      transition: all 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 8px rgba(13,110,253,0.6);
      transform: scale(1.02);
    }

    /* Keyframes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes floatUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* === DARK MODE === */
    body.dark-mode {
      background: #1e1e1e;
      color: #eee;

    }

    body.dark-mode .card,
    body.dark-mode .chart-container,
    body.dark-mode .calendar {
      background: #2b2b2b;
      color: #ddd;
      box-shadow: 0 4px 10px rgba(255,255,255,0.05);
    }

    body.dark-mode .navbar {
      background: #111 !important;
    }

    body.dark-mode .list-group-item {
      background: #2b2b2b;
      color: #ddd;
    }

    body.dark-mode .btn-success {
      background: linear-gradient(90deg, #3a7bd5, #3a6073);
    }

    body.dark-mode .btnA {
      background: #444;
      color: #fff;
    }
    body.dark-mode .btnA:hover {
      background: #666;
    }

    body.dark-mode .navbar {
      background-color: white !important;
      color: black !important;
    }

    body.dark-mode .navbar a,
    body.dark-mode .navbar-brand,
    body.dark-mode .navbar-nav .nav-link {
      color: black !important;
    }

    body.dark-mode .card {
      background: #ffffff !important;
      color: #000000 !important;
    }

    body.dark-mode .card h5,
    body.dark-mode .card p {
      color: #000000 !important;
    }

    body.dark-mode .chart-container {
      background: #ffffff !important;
      color: #000000 !important;
    }

    body.dark-mode .calendar .weekdays div {
      background: #000000;
      color: #ffffff;
    }

    body.dark-mode .calendar .days .day,
    body.dark-mode .calendar .days .empty {
      background: #ffffff;
      color: #000000;
      border-color: #444;
    }

    body.dark-mode .calendar .days .today {
      border: 2px solid #66b2ff;
    }

    body.dark-mode .list-group-item {
      background-color: #ffffff !important;
      color: #000000 !important;
      border-color: #ddd !important;
    }

    body.dark-mode .list-group-item .btn-outline-danger {
      color: #dc3545 !important;
      border-color: #dc3545 !important;
    }

    body.dark-mode .list-group-item .btn-outline-danger:hover {
      background-color: #dc3545 !important;
      color: #ffffff !important;
    }

    #modeToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      padding: 10px 15px;
      border-radius: 50%;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #modeToggle:hover {
      transform: scale(1.1) rotate(10deg);
      background: #0b5ed7;
    }

  </style>
</head>
<body>
  <!-- Top Navbar -->
  <nav class="navbar navbar-expand-lg bg-dark navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#dashboard"><img src="/static/profile/pepelegeg.png" alt="logo" width="80px" height="80px" class="me-2">pepelegeg</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topnav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="topnav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0" id="navTabs">
          <li class="nav-item"><a class="nav-link" href="#dashboard" data-section="dashboard">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="#tasks" data-section="tasks">Tasks</a></li>
          <li class="nav-item"><a class="nav-link" href="#habits" data-section="habits">Habits</a></li>
          <li class="nav-item"><a class="nav-link" href="#budget" data-section="budget">Budget</a></li>
          <li class="nav-item"><a class="nav-link" href="logout" style="border: 1px solid rgb(0, 229, 255); padding: 10px; border-radius: 12px;background-color: transparent; color: rgb(0, 229, 255); width: 80px;">Log Out</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-4">

    <!-- DASHBOARD -->
  <section id="dashboard" class="section d-flex flex-column align-items-center text-center">
  <h1 class="mb-4"></h1>
  <div class="row g-3 justify-content-center p-3" style="width:100%;">
    <div class="col-md-3">
      <div class="card shadow p-3 d-flex flex-column justify-content-center align-items-center">
        <h5>Tasks</h5>
        <p>{{ tasks|length }} total</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow p-3 d-flex flex-column justify-content-center align-items-center">
        <h5>Habits</h5>
        <p>{{ habits|length }} total</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow p-3 d-flex flex-column justify-content-center align-items-center">
        <h5>Budget</h5>
        <p>Income: {{ budget_income }}<br>Expense: {{ budget_expense }}</p>
      </div>
    </div>
  </div>
</section>
          
    <section id="stats" class="section">
      <h2>Stats</h2>
      <div style="display: flex; flex-direction: row; justify-content: center; gap: 20px; padding: 50px;">
      <div class="chart-container"><canvas id="taskChart" width="400px" height="400px"></canvas></div>
      <div class="chart-container"><canvas id="budgetChart" width="400px" height="400px"></canvas></div>
      </div>
    </section>

    <!-- TASK MANAGER -->
    <section id="tasks" class="section">
      <h2>Task Calendar</h2><br>
      <div class="nav d-flex justify-content-between my-2">
        <a href="/?year={{ prev_year }}&month={{ prev_month }}" class="btnA">← Bulan Sebelumnya</a>
        <span>{{ month_name }} {{ year }}</span>
        <a href="/?year={{ next_year }}&month={{ next_month }}" class="btnA">Bulan Berikutnya →</a>
      </div>

      <div class="calendar border rounded">
        <div class="weekdays d-grid" style="grid-template-columns:repeat(7,1fr);">
          <div>Sunday</div><div>Monday</div><div>Tuesday</div>
          <div>Wednesday</div><div>Thursday</div><div>Friday</div><div>Saturday</div>
        </div>
        <div class="days d-grid" style="grid-template-columns:repeat(7,1fr);">
          {% for week in calendar %}
            {% for day in week %}
              {% if day == 0 %}
                <div class="empty border" style="min-height:100px;"></div>
              {% else %}
                {% set date_str = '%04d-%02d-%02d'|format(year, month, day) %}
                <div class="day border p-1 {% if date_str==current_date.strftime('%Y-%m-%d') %}today{% endif %}"
                    onclick="openModal('{{ date_str }}')"
                    {% if date_str in moods_by_date %}
                    style="{{ 'background:yellow;' if moods_by_date[date_str]=='Happy' 
                             else 'background:lightblue;' if moods_by_date[date_str]=='Sad' 
                             else 'background:red;' if moods_by_date[date_str]=='Angry' 
                             else 'background:lightgreen;' if moods_by_date[date_str]=='Disgust' 
                             else 'background:orange;' if moods_by_date[date_str]=='Anxious'
                             else 'background:white;' if moods_by_date[date_str]=='Pilih Mood' 
                             else '' }}"
                    {% endif %}>

                  <span class="fw-bold small">{{ day }}</span>
                  {% if date_str in tasks_by_date %}
                    <div class="task-preview small mt-1">
                      {% for t in tasks_by_date[date_str][:2] %}
                        <div class="{% if t.done %}text-decoration-line-through text-muted{% endif %}">• {{ t.text }}</div>
                      {% endfor %}
                      {% if tasks_by_date[date_str]|length > 2 %}
                        <div class="text-muted">+{{ tasks_by_date[date_str]|length-2 }} lagi</div>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- MODAL TASK -->
    <div id="taskModal" class="modal hidden" aria-hidden="true"
        style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);
                display:flex;align-items:center;justify-content:center;">
      <div class="modal-content bg-white p-3 rounded" style="width:320px;">
        <h5 id="modalDate"></h5>

        <!-- Form Task -->
        <form id="taskForm" class="d-flex my-2">
          <input type="text" id="taskInput" class="form-control me-2" placeholder="Task baru...">
          <button class="btn btn-success">Add</button>
        </form>

        <!-- Form Mood -->
        <form id="moodForm" class="d-flex my-2">
          <select id="moodSelect" class="form-select me-2">
            <option value="">Select Mood</option>
            <option value="Happy">Happy</option>
            <option value="Sad">Sad</option>
            <option value="Angry">Angry</option>
            <option value="Disgust">Disgust</option>
            <option value="Anxious">Anxious</option>
          </select>
          <button class="btn btn-primary">Save</button>
        </form>

        <div id="taskList" class="mt-2"></div>
        <button class="btn btn-secondary mt-2" onclick="closeModal()">Tutup</button>
      </div>
    </div>
    <br><br>
    <!-- HABIT TRACKER -->
    <section id="habits" class="section">
      <h2>Habit Tracker</h2><br>
      <form method="post" action="{{ url_for('habit') }}" class="d-flex mb-3">
        <input type="text" name="habit_name" class="form-control me-2" placeholder="New habit..." required>
        <button type="submit" class="btn btn-success">Add</button>
      </form>

      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Habit</th>
            {% for d in week_days %}
              <th>{{ d.strftime("%a %d") }}</th>
            {% endfor %}
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for habit in habits %}
            <tr>
              <td>{{ habit.name }}</td>
              {% for d in habit.days %}
                <td class="text-center">
                  <a href="{{ url_for('toggle', habit_id=habit.id, date_str=d.date) }}">
                    <input type="checkbox" {% if d.done %}checked{% endif %} onclick="return false;">
                  </a>
                </td>
              {% endfor %}
              <td class="text-center">
                <a href="{{ url_for('delete_habit', habit_id=habit.id) }}" class="btn btn-sm btn-outline-danger">❌</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
    <br><br>
    <!-- BUDGET -->
    <section id="budget" class="section">
      <h2>Budget Planner</h2><br>
      <form method="POST" action="{{ url_for('budget') }}" class="row g-2 mb-3">
        <div class="col-md-3">
          <select name="type" class="form-select">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>
        <div class="col-md-3 " >
          <input type="number" name="amount" class="form-control" placeholder="Amount" required>
        </div>
        <div class="col-md-4">
          <input type="text" name="desc" class="form-control" placeholder="Description">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-success w-100">Add</button>
        </div>
      </form>
      <ul class="list-group">
        {% for b in budgets %}
          <li class="list-group-item d-flex justify-content-between">
            {{ b.type|capitalize }} - {{ b.amount }}{% if b.description %} ({{ b.description }}){% endif %}
            <a href="{{ url_for('budget_delete', budget_id=b.id) }}" class="btn btn-sm btn-outline-danger">🗑</a>
          </li>
        {% endfor %}
      </ul>
    </section>

  </main>
  <button id="modeToggle">🌙</button>

  <script>
  // ---- Section Switching + Active Nav ----
  const sections = document.querySelectorAll('.section');
  const navLinks = document.querySelectorAll('#navTabs .nav-link');

  function showSection(id){
    sections.forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
    navLinks.forEach(a => a.classList.toggle('active', a.getAttribute('data-section') === id));
    if(id === 'dashboard') initChartsOnce();
  }

  function handleHash(){
    const id = (location.hash || '#dashboard').replace('#','');
    showSection(id);
  }

  window.addEventListener('hashchange', handleHash);
  document.addEventListener('DOMContentLoaded', handleHash);

  // ---- Charts ----
  let chartsInited = false;
  function initChartsOnce(){
    if(chartsInited) return; chartsInited = true;

    const completed = {{ completed_tasks|tojson }};
    const total = {{ total_tasks|tojson }};
    const pending = Math.max(0, total - completed);

    const budgetIncome = {{ budget_income|tojson }};
    const budgetExpense = {{ budget_expense|tojson }};

    new Chart(document.getElementById('taskChart'), {
      type: 'doughnut',
      data: {
        labels: ['Selesai', 'Belum Selesai'],
        datasets: [{ data: [completed, pending] }]
      }
    });

    new Chart(document.getElementById('budgetChart'), {
      type: 'bar',
      data: {
        labels: ['Pemasukan', 'Pengeluaran'],
        datasets: [{ data: [budgetIncome, budgetExpense] }]
      },
      options: { scales: { y: { beginAtZero: true }}}
    });
  }

  // ---- TASK MODAL ----
  let currentDate = null;

  function openModal(date) {
    currentDate = date;
    document.getElementById("modalDate").textContent = "Tanggal: " + date;
    loadTasks(date);
    document.getElementById("taskModal").classList.remove("hidden");
  }

  function closeModal() {
    document.getElementById("taskModal").classList.add("hidden");
  }

  async function loadTasks(date) {
    const res = await fetch(`/api/tasks/${date}`);
    const data = await res.json();
    const list = document.getElementById("taskList");
    list.innerHTML = "";

    if (!data.tasks || data.tasks.length===0) {
      list.innerHTML = "<p>Belum ada task.</p>";
      return;
    }

    data.tasks.forEach(t=>{
      const div = document.createElement("div");
      div.className="d-flex justify-content-between align-items-center mb-1";
      div.innerHTML = `
        <input type="checkbox" ${t.done ? "checked": ""} onchange="toggleTask(${t.id})">
        <span class="flex-grow-1 ms-2 ${t.done ? 'text-decoration-line-through text-muted':''}">${t.text}</span>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.id})">❌</button>`;
      list.appendChild(div);
    });
  }

  // ---- TASK FORM ----
  document.getElementById("taskForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const input = document.getElementById("taskInput");
    const task = (input.value || "").trim();
    if (!task) return;

    await fetch("/api/tasks",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({date: currentDate, task})
    });
    input.value = "";
    await loadTasks(currentDate);
    updateStats();
  });

  // ---- MOOD FORM ----
  document.getElementById("moodForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const mood = document.getElementById("moodSelect").value;
    if (!mood) return;
    await fetch("/api/mood",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({date: currentDate, mood})
    });
  });

  // ---- TASK ACTIONS ----
  async function deleteTask(id){
    await fetch(`/api/tasks/${currentDate}/${id}`, { method:"DELETE" });
    await loadTasks(currentDate);
    updateStats();
  }

  async function toggleTask(id){
    await fetch(`/api/tasks/${currentDate}/${id}/toggle`, { method:"PUT" });
    await loadTasks(currentDate);
    updateStats();
  }

  // ---- UPDATE STATS (tanpa reload page) ----
  async function updateStats(){
    const res = await fetch(`/api/stats`);
    const stats = await res.json();

    // Update chart data (kalau chart udah diinisialisasi)
    if(chartsInited){
      const taskChart = Chart.getChart("taskChart");
      if(taskChart){
        taskChart.data.datasets[0].data = [stats.completed, stats.total - stats.completed];
        taskChart.update();
      }
    }
  }

  // ---- ESC close modal ----
  document.addEventListener("keydown", e=>{ if(e.key==="Escape") closeModal(); });

    const toggleBtn = document.getElementById("modeToggle");
  let dark = false;

  toggleBtn.addEventListener("click", ()=>{
    dark = !dark;
    document.body.classList.toggle("dark-mode", dark);
    toggleBtn.textContent = dark ? "☀️" : "🌙";
  });
</script>

</body>
</html>
